{%- liquid
  assign message = settings.freegift_message 
  assign show_message = false
  if message != blank
    assign show_message = true
  endif

  # Assign the free gift limit and calculate the halfway point
  assign free_shipping_limit = settings.free_gift_limit
  assign half_limit = free_shipping_limit | divided_by: 2
  
  # Ensure the subtotal is properly divided and handled as a number
  assign subtotal_without_currency = cart.total_price | divided_by: 100

  # Debugging output to check values
  assign debug_subtotal = subtotal_without_currency
  assign debug_half_limit = half_limit

  # Explicitly check if the subtotal is greater than or equal to the half limit
  if subtotal_without_currency >= half_limit
    assign debug_show_halfway_message = true
  else
    assign debug_show_halfway_message = false
  endif

  # Optional: Check if the values are numbers (force conversion)
  assign debug_is_subtotal_number = subtotal_without_currency | class
  assign debug_is_half_limit_number = half_limit | class
-%}

{%- comment -%}
<p>Debugging Subtotal: {{ debug_subtotal }}</p>
<p>Debugging Half Limit: {{ debug_half_limit }}</p>
<p>Debugging Show Halfway Message: {{ debug_show_halfway_message }}</p>
<p>Is Subtotal a Number? {{ debug_is_subtotal_number }}</p>
<p>Is Half Limit a Number? {{ debug_is_half_limit_number }}</p>
{%- endcomment -%}

{%- if show_message and debug_show_halfway_message -%}
  {%- liquid
    assign limit = free_shipping_limit | plus: 0
    assign limit_currency = limit | times: 100
    assign percent = limit | minus: subtotal_without_currency | times: 100 | divided_by: limit
    assign percent = 100 | minus: percent

    if settings.currency_code_enable
      assign limit_currency = limit_currency | minus: cart.total_price | money_with_currency
    else
      assign limit_currency = limit_currency | minus: cart.total_price | money_without_trailing_zeros
    endif

    capture left_to_spend
      echo '<span data-left-to-spend>' | append: limit_currency | append: '</span>'
    endcapture

    assign message = message | replace: '||amount||', left_to_spend
    assign qualified_shipping_message = settings.qualified_freegift_message  

    capture free_gift_classes
      if is_cart_drawer
        echo 'drawer__message '
      endif

      if template.name == 'cart'
        echo 'cart__message '
      endif

      echo 'free-shipping free-gift boxy-xs'

      if subtotal_without_currency >= limit and qualified_shipping_message != blank
        echo ' is-success'
      endif
    endcapture
  -%}

  <div class="{{ free_gift_classes }}"
    data-free-shipping="{% if qualified_shipping_message != blank %}true{% else %}false{% endif %}"
    data-free-shipping-limit="{{ limit }}"
    {% if style != blank %} style="{{ style }}" {% endif %}
  >
    {%- if qualified_shipping_message != blank -%}
      <span class="free-shipping__success-message free-gift__success-message">{{ qualified_shipping_message }}</span>
    {%- endif -%}

    <span class="free-shipping__default-message free-gift__default-message">
      {{ message }}
    </span>

    <progress class="free-shipping__progress-bar free-gift__progress-bar" data-progress-bar value="{{ percent }}" max="100"></progress>
  </div>
{%- endif -%}
