{% comment %}
  Renders a header drawer menu for mobile and desktop.

  Usage:
  {% render 'header-drawer' %}
{% endcomment %}

<header-drawer data-breakpoint="{% if section.settings.menu_type_desktop == 'drawer' %}desktop{% else %}tablet{% endif %}">
  <details id="Details-menu-drawer-container" class="menu-drawer-container">
    <summary
      class="header__icon header__icon--menu header__icon--summary link focus-inset"
      aria-label="{{ 'sections.header.menu' | t }}"
    >
      <span>
        {{- 'icon-hamburger.svg' | inline_asset_content -}}
        {{- 'icon-close-new.svg' | inline_asset_content -}}
      </span>
    </summary>
    <div id="menu-drawer" class="gradient menu-drawer motion-reduce color-{{ section.settings.menu_color_scheme }}">
      <div class="menu-drawer__inner-container">
        <div class="menu-drawer__navigation-container">
          <nav class="menu-drawer__navigation">
            <ul class="menu-drawer__menu has-submenu list-menu" role="list">
              {%- for link in section.settings.menu.links -%}
                {%- liquid
                  assign parent_index = forloop.index
                  assign has_sub_menu = false
                  assign image_block_index = false
                  assign has_image = false
                  assign image_blocks = blocks | where: 'type', 'image_picker'

                  if link.links.size > 0
                    assign has_sub_menu = true
                  endif

                  for block in image_blocks
                    assign position = block.settings.position | plus: 0
                    if position == parent_index
                      assign has_image = true
                      assign image_block_index = forloop.index0
                    endif
                  endfor

                  assign image_blockz = image_blocks[image_block_index]
                -%}
                <li>
                  {%- if link.links != blank -%}
                    <details id="Details-menu-drawer-menu-item-{{ forloop.index }}">
                      <summary
                        id="HeaderDrawer-{{ link.handle }}"
                        class="menu-drawer__menu-item list-menu__item link link--text focus-inset{% if link.child_active %} menu-drawer__menu-item--active{% endif %}"
                      >

                      {%- assign collection = collections[link.handle] -%} 
                      
                       {%- if collection != blank and collection.image != blank -%}
                        <div class="menu-image-icon">
                          <img src="{{ collection.image | image_url: width: 100 }}" alt="{{ collection.title | escape }}" class="menu-collection-image">
                        </div>
                      {%- endif -%}  

                        <span>{{ link.title | escape }}</span>
                        <span class="svg-wrapper">
                          {{- 'icon-plus.svg' | inline_asset_content -}}
                          {{- 'icon-minus.svg' | inline_asset_content -}}
                        </span>
                      </summary>
                      <div
                        id="link-{{ link.handle | escape }}"
                        class="menu-drawer__submenu has-submenu gradient motion-reduce"
                        tabindex="-1"
                      >
                        <div class="menu-drawer__inner-submenu">
                          <ul class="menu-drawer__menu list-menu" role="list" tabindex="-1">
                            {%- for childlink in link.links -%}
                              <li>
                                {%- if childlink.links == blank -%}
                                  <a
                                    id="HeaderDrawer-{{ link.handle }}-{{ childlink.handle }}"
                                    href="{{ childlink.url }}"
                                    class="menu-drawer__menu-item link link--text list-menu__item focus-inset{% if childlink.current %} menu-drawer__menu-item--active{% endif %}"
                                    {% if childlink.current %}
                                      aria-current="page"
                                    {% endif %}
                                  >
                                    {{ childlink.title | escape }}
                                  </a>
                                {%- else -%}
                                  <a
                                    id="HeaderDrawer-{{ link.handle }}-{{ childlink.handle }}"
                                    href="{{ childlink.url }}"
                                    class="menu-drawer__menu-item link link--text list-menu__item focus-inset{% if childlink.current %} menu-drawer__menu-item--active{% endif %}"
                                    {% if childlink.current %}
                                      aria-current="page"
                                    {% endif %}
                                  >
                                    {{ childlink.title | escape }}
                                  </a>
                                      <ul
                                        class="menu-drawer__menu list-menu"
                                        role="list"
                                        tabindex="-1"
                                      >
                                        {%- for grandchildlink in childlink.links -%}
                                          <li>
                                            <a
                                              id="HeaderDrawer-{{ link.handle }}-{{ childlink.handle }}-{{ grandchildlink.handle }}"
                                              href="{{ grandchildlink.url }}"
                                              class="menu-drawer__menu-item link link--text list-menu__item focus-inset{% if grandchildlink.current %} menu-drawer__menu-item--active{% endif %}"
                                              {% if grandchildlink.current %}
                                                aria-current="page"
                                              {% endif %}
                                            >
                                              {{ grandchildlink.title | escape }}
                                            </a>
                                          </li>
                                        {%- endfor -%}
                                      </ul>
                                {%- endif -%}
                              </li>
                            {%- endfor -%}
                          </ul>

                          {%- if has_image -%}
                            <div class="menu-image-grid">
                              {%- for block in image_blocks -%}
                                {%- assign position = block.settings.position | plus: 0 -%}
                                {%- if position == parent_index -%}
                                  {%- liquid
                                    assign image_block = block.settings.image_block | img_url: 'large'
                                    assign image_link = block.settings.image_link
                                    assign heading = block.settings.image_title | default: ''
                                  -%}

                                  <div class="full-menu--image">
                                    {%- if image_link != null -%}
                                      <a href="{{ image_link }}" title="{{ heading | escape }}">
                                    {%- endif -%}
                                    <div class="full-menu--image-image">
                                      <img src="{{ image_block }}" alt="{{ heading | escape }}">
                                    </div>
                                    {%- if heading -%}
                                      <div class="full-menu--image-cover">
                                        <p>{{ heading }}</p>
                                      </div>
                                    {%- endif -%}
                                    {%- if image_link != null -%}</a>{%- endif -%}
                                  </div>
                                {%- endif -%}
                              {%- endfor -%}
                            </div>
                          {%- endif -%}

                        </div>
                      </div>
                    </details>
                  {%- else -%}
                    <a
                      id="HeaderDrawer-{{ link.handle }}"
                      href="{{ link.url }}"
                      class="menu-drawer__menu-item list-menu__item link link--text focus-inset{% if link.current %} menu-drawer__menu-item--active{% endif %}"
                      {% if link.current %}
                        aria-current="page"
                      {% endif %}
                    >
                      {%- assign collection = collections[link.handle] -%} 
                      
                       {%- if collection != blank and collection.image != blank -%}
                        <div class="menu-image-icon">
                          <img src="{{ collection.image | image_url: width: 100 }}" alt="{{ collection.title | escape }}" class="menu-collection-image">
                        </div>
                      {%- endif -%}                      
                      <span>{{ link.title | escape }}</span>
                    </a>
                  {%- endif -%}
                  
                </li>
              {%- endfor -%}
            </ul>
          </nav>
          <div class="menu-drawer__utility-links">
            {%- if shop.customer_accounts_enabled -%}
              <a
                href="{%- if customer -%}{{ routes.account_url }}{%- else -%}{{ routes.account_login_url }}{%- endif -%}"
                class="menu-drawer__account link focus-inset h5 medium-hide large-up-hide"
                rel="nofollow"
              >
                {%- if section.settings.enable_customer_avatar -%}
                  <account-icon>
                    {%- if customer and customer.has_avatar? -%}
                      {{ customer | avatar }}
                    {%- else -%}
                      <span class="svg-wrapper">
                        {{- 'icon-account.svg' | inline_asset_content -}}
                      </span>
                    {%- endif -%}
                  </account-icon>
                {%- else -%}
                  <span class="svg-wrapper">
                    {{- 'icon-account.svg' | inline_asset_content -}}
                  </span>
                {%- endif -%}
                {%- liquid
                  if customer
                    echo 'customer.account_fallback' | t
                  else
                    echo 'customer.log_in' | t
                  endif
                -%}
              </a>
            {%- endif -%}
            {%- if localization.available_countries or localization.available_languages -%}
              <div class="menu-drawer__localization header-localization localization_top_left">
              <div class="disclosure">
                <button type="button" class="disclosure__button localization-form__select localization-selector link link--text caption-large" aria-expanded="false" aria-controls="AnnouncementCountry-country-results" aria-describedby="AnnouncementCountryLabel">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 0C4.486 0 0 4.486 0 10C0 15.514 4.486 20 10 20C15.514 20 20 15.514 20 10C20 4.486 15.514 0 10 0ZM17.931 9H15.167C15.0436 6.81124 14.4313 4.67797 13.375 2.757C14.5992 3.32905 15.6589 4.2014 16.4554 5.29291C17.252 6.38442 17.7596 7.65965 17.931 9ZM10.53 2.027C11.565 3.391 12.957 5.807 13.157 9H7.03C7.169 6.404 8.024 3.972 9.481 2.026C9.653 2.016 9.825 2 10 2C10.179 2 10.354 2.016 10.53 2.027ZM6.688 2.727C5.704 4.618 5.136 6.762 5.03 9H2.069C2.24177 7.64784 2.75663 6.3621 3.56489 5.26442C4.37315 4.16673 5.44808 3.29339 6.688 2.727ZM2.069 11H5.043C5.179 13.379 5.708 15.478 6.599 17.23C5.38119 16.6559 4.32773 15.7842 3.53596 14.6953C2.74419 13.6064 2.23966 12.3355 2.069 11ZM9.45 17.973C8.049 16.275 7.222 13.896 7.041 11H13.154C12.946 13.773 12.037 16.196 10.551 17.972C10.369 17.984 10.187 18 10 18C9.814 18 9.633 17.984 9.45 17.973ZM13.461 17.201C14.416 15.407 14.999 13.3 15.152 11H17.93C17.7612 12.3243 17.264 13.5853 16.4834 14.6684C15.7029 15.7514 14.6639 16.622 13.461 17.201Z" fill="#2B4676"/>
                  </svg>
                  <span>{{ request.store_id }}</span>              
                </button>
                <div class="disclosure__list-wrapper country-selector" hidden="true">
                  <div class="disclosure__list country-selector__list country-selector__list--with-multiple-currencies" id="AnnouncementCountry-country-results">
                    <ul role="list" class="locations list-unstyled countries">
                      <li class="location__us">
                        <a href="{{ settings.location_us }}" data-location="united-states" 
                          {% if request.url == settings.location_us %}class="local-active"{% endif %}>US</a>
                      </li>
                      <li class="location__uk">
                        <a href="{{ settings.location_uk }}" data-location="uk" 
                          {% if request.url == settings.location_uk %}class="local-active"{% endif %}>UK</a>
                      </li>
                      <li class="location__eu">
                        <a href="{{ settings.location_eu }}" data-location="europe" 
                          {% if request.url == settings.location_eu %}class="local-active"{% endif %}>EU</a>
                      </li>
                      <li class="location__aus">
                        <a href="{{ settings.location_au }}" data-location="australia" 
                          {% if request.url == settings.location_au %}class="local-active"{% endif %}>AU</a>
                      </li>
                    </ul>
                  </div> 
                </div>
              </div>  
              </div>
            {%- endif -%}
        
          </div>
        </div>
      </div>
    </div>
  </details>
</header-drawer>
